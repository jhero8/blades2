<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Bladder Diary">
    <title>Bladder Diary</title>
    <style>
        /* Basic reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #f7f7f7;
            color: #333;
            line-height: 1.6;
            padding: 16px;
            max-width: 500px;
            margin: 0 auto;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        
        /* Header styles */
        header {
            text-align: center;
            margin-bottom: 16px;
        }
        
        .app-logo {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f9cf9, #a651e6, #f9c74f);
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-logo-inner {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-logo-core {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f9cf9, #a651e6, #f9c74f);
            opacity: 0.8;
        }
        
        h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 4px;
        }
        
        .subtitle {
            font-size: 14px;
            color: #666;
        }
        
        /* Privacy notice */
        .privacy-notice {
            text-align: center;
            font-size: 12px;
            color: #718096;
            background-color: rgba(237, 242, 247, 0.7);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 16px;
            line-height: 1.4;
        }
        
        .privacy-notice svg {
            width: 14px;
            height: 14px;
            vertical-align: middle;
            margin-right: 4px;
        }
        
        /* Button styles */
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            margin-bottom: 16px;
            font-size: 16px;
        }
        
        .btn-primary {
            background-color: #5a67d8;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #4c51bf;
        }
        
        .btn-success {
            background-color: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #38a169;
        }
        
        .btn-danger {
            background-color: #e53e3e;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            display: inline-block;
            width: auto;
            margin-bottom: 0;
        }
        
        .btn-secondary {
            background-color: #4299e1;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            margin: 8px 0;
            display: inline-block;
        }
        
        /* Timer button styles */
        .timer-btn {
            background-color: #4299e1;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
        }
        
        .timer-btn.active {
            background-color: #e53e3e;
        }
        
        .timer-btn svg {
            margin-right: 4px;
            width: 14px;
            height: 14px;
        }
        
        /* Timer indicator */
        .timer-indicator {
            display: inline-block;
            margin-left: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #e53e3e;
        }
        
        /* Timer field container */
        .timer-field-container {
            display: flex;
            align-items: center;
        }
        
        /* Form styles */
        .form {
            background-color: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }
        
        .form.hidden {
            display: none;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group.grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #4a5568;
        }
        
        .form-control {
            display: block;
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-control:focus {
            border-color: #a0aec0;
            outline: none;
        }
        
        .form-check {
            display: flex;
            align-items: center;
        }
        
        .form-check-input {
            margin-right: 8px;
        }
        
        .section-header {
            font-size: 16px;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 8px;
            padding-top: 8px;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Entries list */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .card-header {
            background-color: #f8fafc;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 500;
            color: #4a5568;
        }
        
        .card-body {
            padding: 16px;
        }
        
        .entry-item {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .entry-date {
            font-weight: 500;
            color: #2d3748;
        }
        
        .entry-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 4px 8px;
            font-size: 14px;
            color: #4a5568;
        }
        
        .entry-label {
            font-weight: 500;
        }
        
        .no-entries {
            text-align: center;
            color: #a0aec0;
            padding: 24px;
        }
        
        /* Message styles */
        .message {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        
        .message-danger {
            background-color: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
        }
        
        .message-success {
            background-color: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #2f855a;
        }
        
        .hidden {
            display: none;
        }
        
        /* Export section */
        .export-section {
            margin-top: 24px;
            margin-bottom: 32px;
        }
        
        .export-textarea {
            width: 100%;
            height: 200px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 8px;
            display: none;
        }
        
        .helper-text {
            font-size: 12px;
            color: #718096;
            margin-top: 8px;
        }
        
        /* Storage warning */
        .storage-warning {
            background-color: #feebc8;
            border: 1px solid #f6ad55;
            color: #c05621;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }
        
        /* Pull to refresh styles */
        .pull-to-refresh {
            height: 0;
            overflow: hidden;
            text-align: center;
            transition: height 0.3s;
            position: relative;
            margin-bottom: 8px;
        }
        
        .pull-to-refresh-icon {
            display: inline-block;
            margin-top: 10px;
            transition: transform 0.3s;
        }
        
        .pull-to-refresh.visible {
            height: 60px;
        }
        
        .pull-to-refresh.refreshing .pull-to-refresh-icon {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Pulse animation for active timer */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        /* Dashboard section */
        .dashboard-section {
            margin-top: 24px;
            margin-bottom: 24px;
        }
        
        .dashboard {
            margin-top: 16px;
        }
        
        .dashboard.hidden {
            display: none;
        }
        
        /* Chart containers */
        .chart-container {
            margin-bottom: 32px;
            background-color: #fcfcfc;
            border-radius: 6px;
            padding: 12px;
            border: 1px solid #f0f0f0;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .chart {
            height: 200px;
            width: 100%;
            position: relative;
        }
        
        /* Bar chart styling */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            height: 150px;
            padding-bottom: 24px;
            position: relative;
        }
        
        .bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 4px;
        }
        
        .bar {
            width: 100%;
            max-width: 32px;
            background: linear-gradient(to top, #4f9cf9, #a651e6);
            border-radius: 4px 4px 0 0;
            transition: height 0.3s;
        }
        
        .bar-label {
            font-size: 10px;
            color: #718096;
            margin-top: 6px;
            text-align: center;
            transform: rotate(-45deg);
            transform-origin: top left;
            position: absolute;
            bottom: 0;
            white-space: nowrap;
        }
        
        .bar-value {
            font-size: 10px;
            color: #4a5568;
            margin-top: 4px;
            position: absolute;
            top: -20px;
        }
        
        /* Pie chart styling */
        .pie-chart {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 150px;
        }
        
        .pie-container {
            position: relative;
            width: 130px;
            height: 130px;
        }
        
        .pie-slice {
            position: absolute;
            width: 100%;
            height: 100%;
            clip-path: polygon(50% 50%, 100% 0, 100% 100%);
            transform-origin: center;
        }
        
        .pie-legend {
            margin-left: 16px;
            display: flex;
            flex-direction: column;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 6px;
            border-radius: 2px;
        }
        
        .legend-label {
            font-size: 12px;
            color: #4a5568;
        }
        
        /* Line chart styling */
        .line-chart {
            height: 150px;
            position: relative;
            margin-top: 24px;
            padding-left: 24px;
        }
        
        .line-chart-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: #e2e8f0;
        }
        
        .line-chart-axis-horizontal {
            position: absolute;
            left: 24px;
            right: 0;
            bottom: 0;
            height: 1px;
            background-color: #e2e8f0;
        }
        
        .line-chart-line {
            position: absolute;
            stroke: #4f9cf9;
            stroke-width: 2;
            fill: none;
        }
        
        .line-chart-area {
            position: absolute;
            fill: rgba(79, 156, 249, 0.1);
        }
        
        .line-chart-point {
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #4f9cf9;
            border-radius: 50%;
            transform: translate(-3px, -3px);
        }
        
        .axis-label {
            position: absolute;
            font-size: 10px;
            color: #718096;
        }
        
        /* Progress indicators */
        .progress-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        .progress-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            background-color: #f7fafc;
            border-radius: 4px;
            margin: 0 4px;
        }
        
        .progress-value {
            font-size: 18px;
            font-weight: 500;
            color: #4f9cf9;
        }
        
        .progress-label {
            font-size: 12px;
            color: #718096;
        }
        
        /* Comparison chart styling */
        .comparison-chart {
            display: flex;
            height: 150px;
            align-items: flex-end;
            position: relative;
        }
        
        .comparison-bar-group {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 4px;
        }
        
        .comparison-bar {
            width: 24px;
            border-radius: 4px 4px 0 0;
            transition: height 0.3s;
        }
        
        .comparison-bar.primary {
            background-color: #4f9cf9;
        }
        
        .comparison-bar.secondary {
            background-color: #a651e6;
        }
        
        .comparison-legend {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        
        .comparison-legend-item {
            display: flex;
            align-items: center;
            margin: 0 8px;
        }
        
        .comparison-legend-color {
            width: 12px;
            height: 12px;
            margin-right: 6px;
        }
        
        /* Stats cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #4f9cf9;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }
        
        /* Empty state styling */
        .empty-chart {
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #a0aec0;
        }
        
        .empty-chart svg {
            width: 24px;
            height: 24px;
            margin-bottom: 8px;
            stroke: #cbd5e0;
        }
        
        .empty-chart-text {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="pull-to-refresh" id="pullToRefresh">
        <div class="pull-to-refresh-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 4v6h-6"></path>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
        </div>
    </div>
    
    <div class="container">
        <header>
            <div class="app-logo">
                <div class="app-logo-inner">
                    <div class="app-logo-core"></div>
                </div>
            </div>
            <h1>Bladder Diary</h1>
            <p class="subtitle">Track your bladder health</p>
        </header>
        
        <div class="privacy-notice">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Your data is stored privately and securely on your device only
        </div>
        
        <div id="storageWarning" class="storage-warning">
            Storage is not working properly. Your entries won't be saved between sessions.
        </div>
        
        <button id="toggleFormBtn" class="btn btn-primary">
            Add New Entry
        </button>
        
        <div id="messageArea" class="message hidden"></div>
        
        <form id="entryForm" class="form hidden">
            <div class="form-group grid">
                <div>
                    <label class="form-label" for="date">Date</label>
                    <input class="form-control" type="date" id="date" name="date" required>
                </div>
                <div>
                    <label class="form-label" for="time">Time</label>
                    <input class="form-control" type="time" id="time" name="time" required>
                </div>
            </div>
            
            <h3 class="section-header">Drink</h3>
            <div class="form-group grid">
                <div>
                    <label class="form-label" for="drinkType">Type</label>
                    <select class="form-control" id="drinkType" name="drinkType">
                        <option value="">Select type</option>
                        <option value="Water">Water</option>
                        <option value="Coffee">Coffee</option>
                        <option value="Tea">Tea</option>
                        <option value="Juice">Juice</option>
                        <option value="Soda">Soda</option>
                        <option value="Alcohol">Alcohol</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="form-label" for="drinkAmount">Amount (ml)</label>
                    <input class="form-control" type="number" id="drinkAmount" name="drinkAmount" placeholder="ml">
                </div>
            </div>
            
            <h3 class="section-header">Urine</h3>
            <div class="form-group grid">
                <div>
                    <label class="form-label" for="urineVolume">Duration (seconds)</label>
                    <div class="timer-field-container">
                        <input class="form-control" type="number" id="urineVolume" name="urineVolume" placeholder="seconds">
                        <button type="button" id="timerBtn" class="timer-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Start
                        </button>
                    </div>
                    <div id="timerIndicator" class="timer-indicator hidden">0s</div>
                </div>
                <div>
                    <label class="form-label" for="urgency">Urgency (0-3)</label>
                    <select class="form-control" id="urgency" name="urgency">
                        <option value="">Select level</option>
                        <option value="0">0 (None)</option>
                        <option value="1">1 (Mild)</option>
                        <option value="2">2 (Moderate)</option>
                        <option value="3">3 (Severe)</option>
                    </select>
                </div>
            </div>
            
            <h3 class="section-header">Urine Flow</h3>
            <div class="form-group">
                <label class="form-label" for="urineStream">Urine Stream</label>
                <select class="form-control" id="urineStream" name="urineStream">
                    <option value="">Select type</option>
                    <option value="Strong">Strong</option>
                    <option value="Intermittent">Intermittent</option>
                    <option value="Weak">Weak</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-success">Save Entry</button>
        </form>
        
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Recent Entries</h2>
            </div>
            <div id="entriesList" class="card-body">
                <p id="noEntriesMsg" class="no-entries">No entries yet. Add your first one!</p>
            </div>
        </div>

        <!-- Dashboard section -->
        <div class="dashboard-section">
            <button id="toggleDashboardBtn" class="btn btn-secondary">Show Dashboard</button>
            
            <div id="dashboard" class="dashboard hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Your Progress Dashboard</h2>
                    </div>
                    <div class="card-body">
                        <div id="noDataMsg" class="no-entries">No data available yet. Add entries to see your dashboard.</div>
                        
                        <div id="dashboardCharts" class="hidden">
                            <!-- Frequency chart -->
                            <div class="chart-container">
                                <h3 class="chart-title">Daily Urination Frequency</h3>
                                <div class="chart" id="frequencyChart"></div>
                            </div>
                            
                            <!-- Urgency levels chart -->
                            <div class="chart-container">
                                <h3 class="chart-title">Urgency Levels</h3>
                                <div class="chart" id="urgencyChart"></div>
                            </div>
                            
                            <!-- Fluid intake vs urination -->
                            <div class="chart-container">
                                <h3 class="chart-title">Fluid Intake vs Urination</h3>
                                <div class="chart" id="correlationChart"></div>
                            </div>
                            
                            <!-- Stream strength distribution -->
                            <div class="chart-container">
                                <h3 class="chart-title">Urine Stream Strength</h3>
                                <div class="chart" id="streamChart"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="export-section">
            <button id="toggleExportBtn" class="btn btn-secondary">Show Export Data</button>
            <textarea id="exportArea" class="export-textarea"></textarea>
            <p class="helper-text">Select all text and copy to save</p>
        </div>
    </div>

    <script>
        // DOM elements
        const toggleFormBtn = document.getElementById('toggleFormBtn');
        const entryForm = document.getElementById('entryForm');
        const entriesList = document.getElementById('entriesList');
        const noEntriesMsg = document.getElementById('noEntriesMsg');
        const toggleExportBtn = document.getElementById('toggleExportBtn');
        const exportArea = document.getElementById('exportArea');
        const messageArea = document.getElementById('messageArea');
        const storageWarning = document.getElementById('storageWarning');
        const pullToRefresh = document.getElementById('pullToRefresh');
        const timerBtn = document.getElementById('timerBtn');
        const timerIndicator = document.getElementById('timerIndicator');
        const urineVolumeInput = document.getElementById('urineVolume');
        const toggleDashboardBtn = document.getElementById('toggleDashboardBtn');
        const dashboard = document.getElementById('dashboard');
        const noDataMsg = document.getElementById('noDataMsg');
        const dashboardCharts = document.getElementById('dashboardCharts');
        
        // Timer variables
        let timerActive = false;
        let timerStart = 0;
        let timerInterval = null;
        
        // Pull-to-refresh variables
        let touchStartY = 0;
        let touchEndY = 0;
        let isRefreshing = false;
        
        // Check if localStorage is available
        let localStorageAvailable = false;
        try {
            localStorage.setItem("test", "test");
            localStorage.removeItem("test");
            localStorageAvailable = true;
            storageWarning.style.display = 'none';
        } catch (e) {
            console.error("localStorage not available:", e);
            storageWarning.style.display = 'block';
            localStorageAvailable = false;
        }
        
        // In-memory storage (backup if localStorage fails)
        let entries = [];
        
        // Timer functionality
        timerBtn.addEventListener('click', function() {
            if (!timerActive) {
                // Start timer
                timerActive = true;
                timerStart = Date.now();
                timerBtn.textContent = 'Stop';
                timerBtn.classList.add('active');
                timerIndicator.classList.remove('hidden');
                timerIndicator.classList.add('pulse');
                
                // Update timer display
                timerInterval = setInterval(function() {
                    const elapsedSeconds = Math.floor((Date.now() - timerStart) / 1000);
                    timerIndicator.textContent = elapsedSeconds + 's';
                }, 1000);
            } else {
                // Stop timer
                timerActive = false;
                clearInterval(timerInterval);
                const elapsedSeconds = Math.floor((Date.now() - timerStart) / 1000);
                
                // Set value to input field
                urineVolumeInput.value = elapsedSeconds;
                
                // Reset timer UI
                timerBtn.textContent = 'Start';
                timerBtn.classList.remove('active');
                timerIndicator.classList.add('hidden');
                timerIndicator.classList.remove('pulse');
            }
        });
        
        // Load entries from storage
        function loadEntries() {
            try {
                if (localStorageAvailable) {
                    const stored = localStorage.getItem('bladderDiaryEntries');
                    if (stored) {
                        entries = JSON.parse(stored);
                    }
                }
                renderEntries();
            } catch (e) {
                console.error("Error loading entries:", e);
                showMessage("Error loading saved entries", "danger");
            }
        }
        
        // Save entries to storage
        function saveEntries() {
            try {
                if (localStorageAvailable) {
                    localStorage.setItem('bladderDiaryEntries', JSON.stringify(entries));
                }
            } catch (e) {
                console.error("Error saving entries:", e);
                showMessage("Error saving entries", "danger");
            }
        }
        
        // Helper function to show a message
        function showMessage(message, type = 'danger') {
            messageArea.textContent = message;
            messageArea.className = `message message-${type}`;
            messageArea.style.display = 'block';
            setTimeout(function() {
                messageArea.style.display = 'none';
            }, 3000);
        }
        
        // Set current date and time
        function setCurrentDateTime() {
            try {
                const now = new Date();
                const dateInput = document.getElementById('date');
                const timeInput = document.getElementById('time');
                
                // Format date as YYYY-MM-DD
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
                
                // Format time as HH:MM
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                timeInput.value = `${hours}:${minutes}`;
            } catch (error) {
                console.error('Error setting date/time', error);
            }
        }
        
        // Toggle form visibility
        toggleFormBtn.addEventListener('click', function() {
            try {
                if (entryForm.style.display === 'none' || entryForm.style.display === '') {
                    entryForm.style.display = 'block';
                    toggleFormBtn.textContent = 'Cancel';
                    setCurrentDateTime();
                } else {
                    // Make sure timer is stopped if form is closed
                    if (timerActive) {
                        timerActive = false;
                        clearInterval(timerInterval);
                        timerBtn.textContent = 'Start';
                        timerBtn.classList.remove('active');
                        timerIndicator.classList.add('hidden');
                        timerIndicator.classList.remove('pulse');
                    }
                    
                    entryForm.style.display = 'none';
                    toggleFormBtn.textContent = 'Add New Entry';
                    entryForm.reset();
                }
            } catch (error) {
                console.error('Error toggling form', error);
                showMessage('Error showing form');
            }
        });
        
        // Format date for display - FIXED to handle timezone issues
        function formatDate(dateString) {
            try {
                // Parse the date parts directly from the string to avoid timezone issues
                const [year, month, day] = dateString.split('-').map(num => parseInt(num, 10));
                
                // Month names for display
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // JavaScript months are 0-based, so subtract 1 from the month
                return `${months[month-1]} ${day}`;
            } catch (error) {
                console.error('Error formatting date', error);
                return dateString;
            }
        }
        
        // Delete entry function
        function deleteEntryAtIndex(index) {
            try {
                if (confirm('Are you sure you want to delete this entry?')) {
                    entries.splice(index, 1);
                    saveEntries();
                    renderEntries();
                    showMessage('Entry deleted', 'success');
                }
            } catch (error) {
                console.error('Error deleting entry', error);
                showMessage('Error deleting entry');
            }
        }
        
        // Make the delete function globally available
        window.deleteEntryAtIndex = deleteEntryAtIndex;
        
        // Render entries list
        function renderEntries() {
            try {
                // Clear all children except noEntriesMsg
                while (entriesList.firstChild) {
                    entriesList.removeChild(entriesList.firstChild);
                }
                
                // Add the "no entries" message back
                entriesList.appendChild(noEntriesMsg);
                
                if (entries.length === 0) {
                    noEntriesMsg.style.display = 'block';
                    return;
                }
                
                noEntriesMsg.style.display = 'none';
                
                // Sort entries by date and time (newest first)
                entries.sort(function(a, b) {
                    // Compare dates directly as strings (YYYY-MM-DD format sorts correctly)
                    if (a.date !== b.date) {
                        return a.date < b.date ? 1 : -1;
                    }
                    // If dates are the same, compare times
                    return a.time < b.time ? 1 : -1;
                });
                
                // Add each entry to the list
                for (let i = 0; i < entries.length; i++) {
                    const entry = entries[i];
                    const entryEl = document.createElement('div');
                    entryEl.className = 'entry-item';
                    
                    let entryHtml = `
                        <div class="entry-header">
                            <div class="entry-date">
                                ${formatDate(entry.date)} at ${entry.time}
                            </div>
                            <button class="btn-danger" type="button" onclick="deleteEntryAtIndex(${i})">
                                Delete
                            </button>
                        </div>
                        <div class="entry-details">
                    `;
                    
                    if (entry.drinkType) {
                        entryHtml += `
                            <div class="entry-label">Drink:</div>
                            <div>${entry.drinkType} (${entry.drinkAmount || 0} ml)</div>
                        `;
                    }
                    
                    if (entry.urineVolume) {
                        entryHtml += `
                            <div class="entry-label">Urine:</div>
                            <div>${entry.urineVolume} seconds (Urgency: ${entry.urgency || 'N/A'})</div>
                        `;
                    }
                    
                    if (entry.urineStream) {
                        entryHtml += `
                            <div class="entry-label">Urine Flow:</div>
                            <div>Stream: ${entry.urineStream}</div>
                        `;
                    }
                    
                    entryHtml += `</div>`;
                    entryEl.innerHTML = entryHtml;
                    entriesList.appendChild(entryEl);
                }
                
                // If dashboard is visible, update it too
                if (!dashboard.classList.contains('hidden')) {
                    renderDashboard();
                }
            } catch (error) {
                console.error('Error rendering entries', error);
                showMessage('Error displaying entries');
            }
        }
        
        // Handle form submission
        entryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                // If timer is still running, stop it
                if (timerActive) {
                    timerActive = false;
                    clearInterval(timerInterval);
                    const elapsedSeconds = Math.floor((Date.now() - timerStart) / 1000);
                    urineVolumeInput.value = elapsedSeconds;
                    timerBtn.textContent = 'Start';
                    timerBtn.classList.remove('active');
                    timerIndicator.classList.add('hidden');
                    timerIndicator.classList.remove('pulse');
                }
                
                // Get form values
                const newEntry = {
                    date: document.getElementById('date').value,
                    time: document.getElementById('time').value,
                    drinkType: document.getElementById('drinkType').value,
                    drinkAmount: document.getElementById('drinkAmount').value,
                    urineVolume: document.getElementById('urineVolume').value,
                    urgency: document.getElementById('urgency').value,
                    urineStream: document.getElementById('urineStream').value
                };
                
                // Add new entry
                entries.push(newEntry);
                
                // Save to storage
                saveEntries();
                
                // Render entries
                renderEntries();
                
                // Reset form and hide
                entryForm.reset();
                entryForm.style.display = 'none';
                toggleFormBtn.textContent = 'Add New Entry';
                
                // Show success message
                showMessage('Entry saved successfully!', 'success');
                
            } catch (error) {
                console.error('Error saving entry', error);
                showMessage('Error saving entry');
            }
        });
        
        // Toggle export data
        toggleExportBtn.addEventListener('click', function() {
            try {
                if (entries.length === 0) {
                    showMessage('No entries to export');
                    return;
                }
                
                if (exportArea.style.display === 'none' || exportArea.style.display === '') {
                    // Create a clean text representation
                    let textData = "BLADDER DIARY ENTRIES\n\n";
                    
                    // Sort by date and time (oldest first for export)
                    const sortedEntries = entries.slice().sort(function(a, b) {
                        // Compare dates directly as strings (YYYY-MM-DD format sorts correctly)
                        if (a.date !== b.date) {
                            return a.date > b.date ? 1 : -1;
                        }
                        // If dates are the same, compare times
                        return a.time > b.time ? 1 : -1;
                    });
                    
                    sortedEntries.forEach(function(entry) {
                        textData += `Date: ${entry.date} Time: ${entry.time}\n`;
                        
                        if (entry.drinkType) {
                            textData += `Drink: ${entry.drinkType} (${entry.drinkAmount || 0} ml)\n`;
                        }
                        
                        if (entry.urineVolume) {
                            textData += `Urine: ${entry.urineVolume} seconds (Urgency: ${entry.urgency || 'N/A'})\n`;
                        }
                        
                        if (entry.urineStream) {
                            textData += `Urine Flow: Stream: ${entry.urineStream}\n`;
                        }
                        
                        textData += `\n`;
                    });
                    
                    // Show in textarea
                    exportArea.value = textData;
                    exportArea.style.display = 'block';
                    exportArea.select();
                    toggleExportBtn.textContent = 'Hide Export Data';
                    showMessage('Select all text and copy to save', 'success');
                } else {
                    exportArea.style.display = 'none';
                    toggleExportBtn.textContent = 'Show Export Data';
                }
                
            } catch (error) {
                console.error('Error exporting data', error);
                showMessage('Error creating export');
            }
        });
        
        // Dashboard toggle functionality
        toggleDashboardBtn.addEventListener('click', function() {
            try {
                if (dashboard.classList.contains('hidden')) {
                    dashboard.classList.remove('hidden');
                    toggleDashboardBtn.textContent = 'Hide Dashboard';
                    renderDashboard();
                } else {
                    dashboard.classList.add('hidden');
                    toggleDashboardBtn.textContent = 'Show Dashboard';
                }
            } catch (error) {
                console.error('Error toggling dashboard', error);
                showMessage('Error showing dashboard');
            }
        });
        
        // Dashboard-related functions
        function renderDashboard() {
            try {
                // Check if we have any data
                if (entries.length === 0) {
                    noDataMsg.style.display = 'block';
                    dashboardCharts.classList.add('hidden');
                    return;
                }

                // We have data, show the charts
                noDataMsg.style.display = 'none';
                dashboardCharts.classList.remove('hidden');

                // Render each chart
                renderFrequencyChart();
                renderUrgencyChart();
                renderCorrelationChart();
                renderStreamChart();
            } catch (error) {
                console.error('Error rendering dashboard', error);
                showMessage('Error displaying dashboard');
            }
        }

        function renderFrequencyChart() {
            try {
                const frequencyChartEl = document.getElementById('frequencyChart');
                frequencyChartEl.innerHTML = '';

                // Group entries by date
                const entriesByDate = {};
                let hasUrineData = false;

                entries.forEach(entry => {
                    if (entry.urineVolume) {
                        hasUrineData = true;
                        
                        if (!entriesByDate[entry.date]) {
                            entriesByDate[entry.date] = 0;
                        }
                        entriesByDate[entry.date]++;
                    }
                });

                if (!hasUrineData) {
                    renderEmptyChart(frequencyChartEl, 'No urination data recorded yet');
                    return;
                }

                // Convert to array and sort by date
                const dateFrequencies = Object.entries(entriesByDate)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .slice(-7); // Only show the last 7 days with data

                // Create bar chart container
                const barChart = document.createElement('div');
                barChart.className = 'bar-chart';
                
                // Find the maximum frequency for scaling
                const maxFrequency = Math.max(...dateFrequencies.map(df => df[1]));
                
                // Add bars
                dateFrequencies.forEach(([date, count]) => {
                    const barContainer = document.createElement('div');
                    barContainer.className = 'bar-container';
                    
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    const barHeight = (count / maxFrequency) * 100;
                    bar.style.height = `${barHeight}%`;
                    
                    const barValue = document.createElement('div');
                    barValue.className = 'bar-value';
                    barValue.textContent = count;
                    
                    const barLabel = document.createElement('div');
                    barLabel.className = 'bar-label';
                    barLabel.textContent = formatDate(date);
                    
                    barContainer.appendChild(bar);
                    barContainer.appendChild(barValue);
                    barContainer.appendChild(barLabel);
                    barChart.appendChild(barContainer);
                });
                
                frequencyChartEl.appendChild(barChart);
            } catch (error) {
                console.error('Error rendering frequency chart', error);
                const frequencyChartEl = document.getElementById('frequencyChart');
                renderEmptyChart(frequencyChartEl, 'Could not generate chart');
            }
        }

        function renderUrgencyChart() {
            try {
                const urgencyChartEl = document.getElementById('urgencyChart');
                urgencyChartEl.innerHTML = '';

                // Count urgency levels
                const urgencyCounts = { '0': 0, '1': 0, '2': 0, '3': 0 };
                let hasUrgencyData = false;

                entries.forEach(entry => {
                    if (entry.urgency) {
                        hasUrgencyData = true;
                        urgencyCounts[entry.urgency]++;
                    }
                });

                if (!hasUrgencyData) {
                    renderEmptyChart(urgencyChartEl, 'No urgency data recorded yet');
                    return;
                }

                // Calculate total for percentages
                const total = Object.values(urgencyCounts).reduce((sum, count) => sum + count, 0);
                if (total === 0) {
                    renderEmptyChart(urgencyChartEl, 'No urgency data recorded yet');
                    return;
                }

                // Create pie chart container
                const pieChart = document.createElement('div');
                pieChart.className = 'pie-chart';
                
                const pieContainer = document.createElement('div');
                pieContainer.className = 'pie-container';
                
                const legend = document.createElement('div');
                legend.className = 'pie-legend';
                
                // Colors for urgency levels
                const colors = {
                    '0': '#48bb78', // Green for none
                    '1': '#ecc94b', // Yellow for mild
                    '2': '#ed8936', // Orange for moderate
                    '3': '#e53e3e'  // Red for severe
                };
                
                // Add pie slices
                let cumulativePercent = 0;
                let hasNonZeroValue = false;

                Object.entries(urgencyCounts).forEach(([level, count]) => {
                    if (count > 0) {
                        hasNonZeroValue = true;
                        const percent = (count / total) * 100;
                        const pieSlice = document.createElement('div');
                        pieSlice.className = 'pie-slice';
                        pieSlice.style.backgroundColor = colors[level];
                        
                        // Calculate rotation for pie slice
                        pieSlice.style.transform = `rotate(${cumulativePercent * 3.6}deg)`;
                        pieSlice.style.clipPath = `polygon(50% 50%, 100% 0, ${percent >= 50 ? '0 0, 0 100%, ' : ''}100% 100%)`;
                        pieSlice.style.width = percent >= 50 ? '100%' : `${percent * 2}%`;
                        
                        cumulativePercent += percent;
                        pieContainer.appendChild(pieSlice);
                        
                        // Add legend item
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        
                        const legendColor = document.createElement('div');
                        legendColor.className = 'legend-color';
                        legendColor.style.backgroundColor = colors[level];
                        
                        const legendLabel = document.createElement('div');
                        legendLabel.className = 'legend-label';
                        let levelText = '';
                        switch(level) {
                            case '0': levelText = 'None'; break;
                            case '1': levelText = 'Mild'; break;
                            case '2': levelText = 'Moderate'; break;
                            case '3': levelText = 'Severe'; break;
                        }
                        legendLabel.textContent = `${levelText} (${count})`;
                        
                        legendItem.appendChild(legendColor);
                        legendItem.appendChild(legendLabel);
                        legend.appendChild(legendItem);
                    }
                });
                
                if (!hasNonZeroValue) {
                    renderEmptyChart(urgencyChartEl, 'No urgency data recorded yet');
                    return;
                }
                
                pieChart.appendChild(pieContainer);
                pieChart.appendChild(legend);
                urgencyChartEl.appendChild(pieChart);
            } catch (error) {
                console.error('Error rendering urgency chart', error);
                const urgencyChartEl = document.getElementById('urgencyChart');
                renderEmptyChart(urgencyChartEl, 'Could not generate chart');
            }
        }

        function renderCorrelationChart() {
            try {
                const correlationChartEl = document.getElementById('correlationChart');
                correlationChartEl.innerHTML = '';

                // Group entries by date
                const dailyData = {};
                let hasData = false;

                entries.forEach(entry => {
                    if (!dailyData[entry.date]) {
                        dailyData[entry.date] = {
                            date: entry.date,
                            drinkAmount: 0,
                            urinationCount: 0
                        };
                    }
                    
                    if (entry.drinkAmount) {
                        hasData = true;
                        dailyData[entry.date].drinkAmount += parseInt(entry.drinkAmount) || 0;
                    }
                    
                    if (entry.urineVolume) {
                        hasData = true;
                        dailyData[entry.date].urinationCount++;
                    }
                });

                if (!hasData) {
                    renderEmptyChart(correlationChartEl, 'Not enough data for correlation');
                    return;
                }

                // Convert to array and sort by date
                const dailyDataArray = Object.values(dailyData)
                    .filter(day => day.drinkAmount > 0 || day.urinationCount > 0)
                    .sort((a, b) => a.date.localeCompare(b.date))
                    .slice(-5); // Last 5 days with data
                    
                if (dailyDataArray.length === 0) {
                    renderEmptyChart(correlationChartEl, 'Not enough data for correlation');
                    return;
                }

                // Create comparison chart
                const comparisonChart = document.createElement('div');
                comparisonChart.className = 'comparison-chart';
                
                // Find max values for scaling
                const maxDrink = Math.max(...dailyDataArray.map(day => day.drinkAmount));
                const maxCount = Math.max(...dailyDataArray.map(day => day.urinationCount));
                
                // Scale factors - drink amount is usually much larger than urination count
                const drinkScale = maxDrink > 0 ? 100 / maxDrink : 0;
                const countScale = maxCount > 0 ? 100 / maxCount : 0;
                
                // Add bar groups
                dailyDataArray.forEach(day => {
                    const barGroup = document.createElement('div');
                    barGroup.className = 'comparison-bar-group';
                    
                    // Drink amount bar
                    const drinkBar = document.createElement('div');
                    drinkBar.className = 'comparison-bar primary';
                    const drinkHeight = Math.max(day.drinkAmount * drinkScale, 5); // Minimum 5px height for visibility
                    drinkBar.style.height = `${drinkHeight}%`;
                    drinkBar.title = `${day.drinkAmount} ml`;
                    
                    // Urination count bar
                    const countBar = document.createElement('div');
                    countBar.className = 'comparison-bar secondary';
                    const countHeight = Math.max(day.urinationCount * countScale * 10, 5); // Scale up for visibility
                    countBar.style.height = `${countHeight}%`;
                    countBar.title = `${day.urinationCount} times`;
                    
                    barGroup.appendChild(drinkBar);
                    barGroup.appendChild(countBar);
                    
                    // Date label
                    const dateLabel = document.createElement('div');
                    dateLabel.className = 'bar-label';
                    dateLabel.textContent = formatDate(day.date);
                    dateLabel.style.position = 'absolute';
                    dateLabel.style.bottom = '-20px';
                    barGroup.appendChild(dateLabel);
                    
                    comparisonChart.appendChild(barGroup);
                });
                
                // Add legend
                const legend = document.createElement('div');
                legend.className = 'comparison-legend';
                
                const drinkLegend = document.createElement('div');
                drinkLegend.className = 'comparison-legend-item';
                const drinkColor = document.createElement('div');
                drinkColor.className = 'comparison-legend-color';
                drinkColor.style.backgroundColor = '#4f9cf9';
                const drinkLabel = document.createElement('span');
                drinkLabel.textContent = 'Fluid intake (ml)';
                drinkLegend.appendChild(drinkColor);
                drinkLegend.appendChild(drinkLabel);
                
                const countLegend = document.createElement('div');
                countLegend.className = 'comparison-legend-item';
                const countColor = document.createElement('div');
                countColor.className = 'comparison-legend-color';
                countColor.style.backgroundColor = '#a651e6';
                const countLabel = document.createElement('span');
                countLabel.textContent = 'Urination frequency';
                countLegend.appendChild(countColor);
                countLegend.appendChild(countLabel);
                
                legend.appendChild(drinkLegend);
                legend.appendChild(countLegend);
                
                correlationChartEl.appendChild(comparisonChart);
                correlationChartEl.appendChild(legend);
            } catch (error) {
                console.error('Error rendering correlation chart', error);
                const correlationChartEl = document.getElementById('correlationChart');
                renderEmptyChart(correlationChartEl, 'Could not generate chart');
            }
        }

        function renderStreamChart() {
            try {
                const streamChartEl = document.getElementById('streamChart');
                streamChartEl.innerHTML = '';

                // Count stream types
                const streamCounts = { 'Strong': 0, 'Intermittent': 0, 'Weak': 0 };
                let hasStreamData = false;
                
                entries.forEach(entry => {
                    if (entry.urineStream && streamCounts.hasOwnProperty(entry.urineStream)) {
                        hasStreamData = true;
                        streamCounts[entry.urineStream]++;
                    }
                });
                
                if (!hasStreamData) {
                    renderEmptyChart(streamChartEl, 'No stream data recorded yet');
                    return;
                }
                
                // Calculate total
                const total = Object.values(streamCounts).reduce((sum, count) => sum + count, 0);
                if (total === 0) {
                    renderEmptyChart(streamChartEl, 'No stream data recorded yet');
                    return;
                }
                
                // Create bar chart for stream distribution
                const barChart = document.createElement('div');
                barChart.className = 'bar-chart';
                
                // Colors for stream types
                const colors = {
                    'Strong': '#48bb78',
                    'Intermittent': '#ecc94b',
                    'Weak': '#e53e3e'
                };
                
                // Add bars
                Object.entries(streamCounts).forEach(([type, count]) => {
                    if (count > 0) {
                        const percent = (count / total) * 100;
                        
                        const barContainer = document.createElement('div');
                        barContainer.className = 'bar-container';
                        
                        const bar = document.createElement('div');
                        bar.className = 'bar';
                        bar.style.height = `${percent}%`;
                        bar.style.backgroundColor = colors[type];
                        
                        const barValue = document.createElement('div');
                        barValue.className = 'bar-value';
                        barValue.textContent = `${Math.round(percent)}%`;
                        
                        const barLabel = document.createElement('div');
                        barLabel.className = 'bar-label';
                        barLabel.textContent = type;
                        barLabel.style.transform = 'none';
                        
                        barContainer.appendChild(bar);
                        barContainer.appendChild(barValue);
                        barContainer.appendChild(barLabel);
                        barChart.appendChild(barContainer);
                    }
                });
                
                streamChartEl.appendChild(barChart);
                
                // Add progress indicator
                const progressSection = document.createElement('div');
                progressSection.className = 'progress-indicator';
                
                // Try to find trends - only if enough entries
                const recentEntries = entries
                    .filter(e => e.urineStream)
                    .sort((a, b) => a.date + a.time < b.date + b.time ? 1 : -1);
                    
                if (recentEntries.length >= 5) {
                    const lastFive = recentEntries.slice(0, 5);
                    const strongCount = lastFive.filter(e => e.urineStream === 'Strong').length;
                    const weakCount = lastFive.filter(e => e.urineStream === 'Weak').length;
                    
                    const trendItem = document.createElement('div');
                    trendItem.className = 'progress-item';
                    
                    const trendValue = document.createElement('div');
                    trendValue.className = 'progress-value';
                    
                    if (strongCount >= 3) {
                        trendValue.textContent = '';
                        trendValue.style.color = '#48bb78';
                    } else if (weakCount >= 3) {
                        trendValue.textContent = '';
                        trendValue.style.color = '#e53e3e';
                    } else {
                        trendValue.textContent = '';
                        trendValue.style.color = '#ecc94b';
                    }
                    
                    const trendLabel = document.createElement('div');
                    trendLabel.className = 'progress-label';
                    trendLabel.textContent = 'Recent Trend';
                    
                    trendItem.appendChild(trendValue);
                    trendItem.appendChild(trendLabel);
                    progressSection.appendChild(trendItem);
                    
                    streamChartEl.appendChild(progressSection);
                }
            } catch (error) {
                console.error('Error rendering stream chart', error);
                const streamChartEl = document.getElementById('streamChart');
                renderEmptyChart(streamChartEl, 'Could not generate chart');
            }
        }

        function renderEmptyChart(container, message) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-chart';
            
            const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            icon.setAttribute('viewBox', '0 0 24 24');
            icon.setAttribute('fill', 'none');
            icon.setAttribute('stroke', 'currentColor');
            icon.setAttribute('stroke-width', '2');
            icon.setAttribute('stroke-linecap', 'round');
            icon.setAttribute('stroke-linejoin', 'round');
            
            const iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            iconPath.setAttribute('d', 'M21.21 15.89A10 10 0 1 1 8 2.83');
            icon.appendChild(iconPath);
            
            const iconPath2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            iconPath2.setAttribute('d', 'M22 12A10 10 0 0 0 12 2v10z');
            icon.appendChild(iconPath2);
            
            const text = document.createElement('div');
            text.className = 'empty-chart-text';
            text.textContent = message;
            
            emptyState.appendChild(icon);
            emptyState.appendChild(text);
            container.appendChild(emptyState);
        }
        
        // Pull-to-refresh functionality
        function startRefreshing() {
            if (isRefreshing) return;
            isRefreshing = true;
            
            pullToRefresh.classList.add('refreshing');
            
            // Simulate a refresh (in this case, just reload entries from storage)
            setTimeout(function() {
                loadEntries();
                pullToRefresh.classList.remove('visible', 'refreshing');
                isRefreshing = false;
                showMessage('Refreshed', 'success');
            }, 800);
        }
        
        // Touch event handlers for pull-to-refresh
        document.addEventListener('touchstart', function(e) {
            // Only trigger if we're at the top of the page
            if (window.scrollY === 0) {
                touchStartY = e.touches[0].clientY;
            }
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
            if (touchStartY > 0 && !isRefreshing) {
                touchEndY = e.touches[0].clientY;
                const distance = touchEndY - touchStartY;
                
                // Only show pull indicator if we're pulling down
                if (distance > 0) {
                    pullToRefresh.classList.add('visible');
                    
                    // Calculate a rotation for the refresh icon based on pull distance
                    const rotationDegrees = Math.min(distance * 2, 180);
                    document.querySelector('.pull-to-refresh-icon').style.transform = `rotate(${rotationDegrees}deg)`;
                }
            }
        }, { passive: true });
        
        document.addEventListener('touchend', function() {
            if (touchStartY > 0 && touchEndY > 0 && !isRefreshing) {
                const distance = touchEndY - touchStartY;
                
                // If pulled far enough, trigger refresh
                if (distance > 60) {
                    startRefreshing();
                } else {
                    // Otherwise, just hide the indicator
                    pullToRefresh.classList.remove('visible');
                }
                
                // Reset values
                touchStartY = 0;
                touchEndY = 0;
            }
        }, { passive: true });
        
        // Initialize app
        entryForm.style.display = 'none';
        exportArea.style.display = 'none';
        setCurrentDateTime();
        loadEntries(); // Load any previously saved entries
    </script>
</body>
</html>
